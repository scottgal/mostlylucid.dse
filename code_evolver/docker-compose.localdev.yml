version: '3.8'

# ============================================================================
# Code Evolver - Local Development Docker Compose
# ============================================================================
#
# This docker-compose file sets up the local development environment with:
# - Loki: Log aggregation system for BugCatcher
# - Qdrant: Vector database for RAG memory
# - Grafana: Visualization dashboard for Loki logs
#
# All data is persisted to Docker volumes for quick restart.
#
# USAGE:
#   docker-compose -f docker-compose.localdev.yml up -d
#   docker-compose -f docker-compose.localdev.yml down
#
# ACCESSING SERVICES:
#   Loki: http://localhost:3100
#   Qdrant: http://localhost:6333
#   Qdrant Dashboard: http://localhost:6333/dashboard
#   Grafana: http://localhost:3000 (admin/admin)
#
# ============================================================================

services:
  # ==========================================================================
  # Loki - Log Aggregation System
  # ==========================================================================
  loki:
    image: grafana/loki:2.9.3
    container_name: code_evolver_loki
    ports:
      - "3100:3100"
    volumes:
      - loki_data:/loki
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - code_evolver_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Qdrant - Vector Database
  # ==========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: code_evolver_qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      # Enable service API key for security (optional)
      # QDRANT__SERVICE__API_KEY: "your-api-key-here"

      # Collection settings
      QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS: 4

      # Logging
      QDRANT__LOG_LEVEL: INFO
    networks:
      - code_evolver_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Grafana - Visualization Dashboard
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: code_evolver_grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning:ro
    environment:
      # Admin credentials
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin

      # Allow anonymous access to dashboards (optional)
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer

      # Loki datasource
      GF_INSTALL_PLUGINS: ""
    networks:
      - code_evolver_network
    depends_on:
      - loki
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================================================
# Docker Volumes - Persistent Storage
# ============================================================================
volumes:
  loki_data:
    driver: local
    name: code_evolver_loki_data

  qdrant_storage:
    driver: local
    name: code_evolver_qdrant_storage

  grafana_data:
    driver: local
    name: code_evolver_grafana_data

# ============================================================================
# Docker Network
# ============================================================================
networks:
  code_evolver_network:
    driver: bridge
    name: code_evolver_network
