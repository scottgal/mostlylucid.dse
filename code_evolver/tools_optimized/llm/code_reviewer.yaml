# Code Reviewer - Optimized Version
# Backend-agnostic tool for code review and quality assessment

name: "Code Reviewer"
type: "llm"
version: "1.1.0"  # Version bump for optimization
description: "Reviews code for quality, best practices, and potential issues. Uses quality tier for thorough analysis with structured output."

# Performance characteristics
cost_tier: "medium"
speed_tier: "fast"
quality_tier: "excellent"
max_output_length: "long"
priority: 110

# LLM configuration (ENHANCED)
llm:
  # Tiered system with fallback chain
  tier: "quality.tier_2"  # Comprehensive quality review
  fallback_tiers:
    - "quality.tier_3"    # If tier_2 unavailable
    - "general"           # Last resort

  # Legacy support
  role: "base"

  # LLM parameters (NEW)
  temperature: 0.3        # Lower temperature for more consistent reviews
  max_tokens: 2000        # Enough for detailed reviews
  top_p: 0.9
  timeout_seconds: 60

  # Retry configuration (NEW)
  retry_config:
    max_attempts: 3
    backoff_factor: 2
    retry_on: ["timeout", "rate_limit", "server_error"]

  system_prompt: |
    You are an expert code reviewer with deep knowledge of software engineering best practices, design patterns, and common pitfalls.

    Your reviews should be:
    - Constructive and specific
    - Focused on important issues, not nitpicks
    - Actionable with clear suggestions
    - Security-aware
    - Performance-conscious

  prompt_template: |
    # CODE REVIEW TASK

    Review this code:

    ```
    {code}
    ```

    ## Required Analysis

    Provide your review in this JSON format:
    {{
      "quality_score": <1-10>,
      "summary": "<one-sentence assessment>",
      "issues": [
        {{
          "severity": "critical|high|medium|low",
          "category": "bug|performance|security|style|maintainability",
          "description": "<what's wrong>",
          "suggestion": "<how to fix>",
          "line": <line number if applicable>
        }}
      ],
      "strengths": ["<positive aspects>"],
      "security_concerns": ["<any security issues>"],
      "performance_notes": ["<performance considerations>"]
    }}

    ## Guidelines
    - Focus on high and critical severity issues first
    - Be specific about what to change and why
    - Consider: correctness, security, performance, maintainability
    - Note any anti-patterns or code smells

# Resource constraints (NEW)
constraints:
  max_memory_mb: 512
  max_execution_time_ms: 90000  # 90 seconds
  max_cost_per_request_usd: 0.10

# Structured input schema (NEW)
input_schema:
  type: object
  properties:
    code:
      type: string
      description: "Code to review"
      required: true
    language:
      type: string
      description: "Programming language"
      default: "python"
    focus_areas:
      type: array
      description: "Specific areas to focus on"
      items:
        type: string
        enum: ["security", "performance", "maintainability", "correctness", "style"]
      default: ["correctness", "security"]

# Structured output schema (NEW)
output_schema:
  type: object
  properties:
    quality_score:
      type: integer
      minimum: 1
      maximum: 10
    summary:
      type: string
    issues:
      type: array
      items:
        type: object
        properties:
          severity:
            type: string
            enum: ["critical", "high", "medium", "low"]
          category:
            type: string
          description:
            type: string
          suggestion:
            type: string
          line:
            type: integer
    strengths:
      type: array
      items:
        type: string
    security_concerns:
      type: array
      items:
        type: string
    performance_notes:
      type: array
      items:
        type: string

# Tags for tool discovery
tags:
  - review
  - quality
  - code-analysis
  - best-practices
  - assessment
  - security
  - performance

# Examples (NEW)
examples:
  - input:
      code: "def calculate(x, y):\n    return x / y"
      language: "python"
    output:
      quality_score: 6
      summary: "Basic function with division by zero risk"
      issues:
        - severity: "high"
          category: "bug"
          description: "No check for division by zero"
          suggestion: "Add validation: if y == 0: raise ValueError('Cannot divide by zero')"
          line: 2

# Usage documentation (ENHANCED)
usage_notes: |
  ## Overview
  Provides comprehensive code review with structured feedback on quality,
  security, performance, and maintainability.

  ## Output Structure
  Returns JSON with:
  - **quality_score**: 1-10 rating
  - **summary**: One-sentence assessment
  - **issues**: Categorized problems with severity levels
  - **strengths**: Positive aspects of the code
  - **security_concerns**: Security-specific issues
  - **performance_notes**: Performance considerations

  ## Severity Levels
  - **critical**: Must fix (security holes, crashes)
  - **high**: Should fix (bugs, major issues)
  - **medium**: Consider fixing (code smells, minor issues)
  - **low**: Nice to have (style, minor improvements)

  ## Categories
  - **bug**: Correctness issues
  - **security**: Security vulnerabilities
  - **performance**: Performance problems
  - **maintainability**: Code quality issues
  - **style**: Formatting and style

  ## Best Practices
  1. Review code before merge
  2. Focus on critical and high severity first
  3. Use with static analysis tools for comprehensive coverage
  4. Consider context - not all suggestions may apply

  ## Performance
  - Typical review time: 5-15 seconds
  - Scales with code size
  - Use timeout for very large files
